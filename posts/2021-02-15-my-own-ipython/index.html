<!doctype html><html lang=en><head><meta charset=utf-8><title>Jay Vala</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Inspired by a video from Sebastiaan Mathôt"><meta property="og:title" content="Writing my own little interactive python environment"><meta property="og:description" content="Inspired by a video from Sebastiaan Mathôt"><meta property="og:type" content="website"><meta property="og:url" content="https://jdvala.github.io/posts/2021-02-15-my-own-ipython/"><meta itemprop=name content="Writing my own little interactive python environment"><meta itemprop=description content="Inspired by a video from Sebastiaan Mathôt"><meta name=twitter:card content="summary"><meta name=twitter:title content="Writing my own little interactive python environment"><meta name=twitter:description content="Inspired by a video from Sebastiaan Mathôt"><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=favicon-32.png><link rel=stylesheet href=https://jdvala.github.io/scss/style.min.d1aa507e320f63a9a89fb4d16c025955cea1564900de1060a4b2d7cabbabcdec.css></head><body><header><div class="header header-frame"><div><h1 class=header__title>Writing my own little interactive python environment</h1><div class=header__description>Inspired by a video from Sebastiaan Mathôt</div></div><nav class=header-nav><ul class="header-nav-list header-nav-list--menu"><li class=header-nav-list__item><a class=header-nav-list__link href=/about/><span>About</span></a></li></ul><button class=header-nav-list__nav-btn>navigation</button></nav><button class=mb-header__menu-btn>
<span class=mb-header__menu-btn-line></span><span class=mb-header__menu-btn-line></span><span class=mb-header__menu-btn-line></span></button></div><nav id=mobile-header-nav class=mb-header-nav><button class="mb-header-nav__close-btn flex-center"><svg class="mb-header-nav__svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"
            ><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                /><path d="M0 0h24v24H0z" fill="none" /></svg></button><div class=mb-header-nav__wrapper><div class=mb-header-nav__container><svg width="240" height="72" viewBox="0 0 240 72" class="mb-header-nav__title"
                ><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Tags</text></svg><ul class=mb-header-nav-list><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://jdvala.github.io/tags/python/>python</a></li><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://jdvala.github.io/tags/python3/>python3</a></li><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://jdvala.github.io/tags/ipython/>ipython</a></li></ul></div><div class=mb-header-nav__container><svg width="240" height="72" viewBox="0 0 240 72" class="mb-header-nav__title"
                ><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Menu</text></svg><ul class=mb-header-nav-list><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=/about/>About</a></li></ul></div></div></nav></header><div id=content><article class=post><div class=post-content><p>Wouldn&rsquo;t it be cool to build just for fun one of the most used and beloved tool in Data Science and Python community, the <code>Interactive Python (ipython) shell</code>.</p><p>The other day I was watching youtube videos, learning all about python and I came across this video by Sebastiaan Mathôt, in which he had built his own <code>ipython</code> shell. I thought it was very cool and I wanted to replicate it. The link for the video is <a href=https://youtu.be/uSmOry4PY0Q>here</a></p><p>We start by thinking about how <code>ipython</code> works, we enter a valid python code and the <code>ipython</code> interpreter evaluates it and gives back the results and spawns a new line for us to write another peice of code. So how can we replicate it? Lets create our main function that gets users input and prints it out.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>from</span> <span style=color:#555>itertools</span> <span style=color:#000;font-weight:700>import</span> count

<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>get_user_input</span>():
    
    <span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>in</span> count():
        <span style=color:#000;font-weight:700>yield</span> i, <span style=color:#0086b3>input</span>(f<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>In [{i}]: </span><span style=color:#d14>&#34;</span>)


<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>main</span>():
    
    <span style=color:#000;font-weight:700>for</span> i, user_input <span style=color:#000;font-weight:700>in</span> get_user_input():
        <span style=color:#000;font-weight:700>pass</span>
    
<span style=color:#000;font-weight:700>if</span> __name__ <span style=color:#000;font-weight:700>==</span>  <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>__main__</span><span style=color:#d14>&#34;</span>:
    main()
</code></pre></div><p>Here in the code above I could have used <code>while</code> loop but I did not want to keep track of <code>i</code> and increment it everytime. <code>Itertools</code> provide <code>count</code> function which returns <code>i</code> and we now have a for loop.</p><p>Now if we run the above code with python we should see something familiar, nice!</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>In <span style=color:#000;font-weight:700>[</span>0<span style=color:#000;font-weight:700>]</span>: 
</code></pre></div><p>And if you keep pressing <code>Enter</code>, new lines will be spawned. So we are good on the part where we need new lines when the previous lines are executed. Cool!</p><p>As we have the first thing out of the way, where user can input their python code. Now what? Do you remember how to quit the prompt? <code>Ctrl + d</code> right? So when you run the program and press <code>Ctrl + d</code>, we get</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>In <span style=color:#000;font-weight:700>[</span>0<span style=color:#000;font-weight:700>]</span>: Traceback <span style=color:#000;font-weight:700>(</span>most recent call last<span style=color:#000;font-weight:700>)</span>:
  File <span style=color:#d14>&#34;test.py&#34;</span>, line 19, in &lt;module&gt;
    main<span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>)</span>
  File <span style=color:#d14>&#34;test.py&#34;</span>, line 14, in main
    <span style=color:#000;font-weight:700>for</span> i, user_input in get_user_input<span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>)</span>:
  File <span style=color:#d14>&#34;test.py&#34;</span>, line 5, in get_user_input
    yield i, input<span style=color:#000;font-weight:700>(</span>f<span style=color:#d14>&#34;In [{i}]: &#34;</span><span style=color:#000;font-weight:700>)</span>
EOFError
</code></pre></div><p>And if you press <code>Ctrl + c</code></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>In <span style=color:#000;font-weight:700>[</span>0<span style=color:#000;font-weight:700>]</span>: ^CTraceback <span style=color:#000;font-weight:700>(</span>most recent call last<span style=color:#000;font-weight:700>)</span>:
  File <span style=color:#d14>&#34;test.py&#34;</span>, line 19, in &lt;module&gt;
    main<span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>)</span>
  File <span style=color:#d14>&#34;test.py&#34;</span>, line 14, in main
    <span style=color:#000;font-weight:700>for</span> i, user_input in get_user_input<span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>)</span>:
  File <span style=color:#d14>&#34;test.py&#34;</span>, line 5, in get_user_input
    yield i, input<span style=color:#000;font-weight:700>(</span>f<span style=color:#d14>&#34;In [{i}]: &#34;</span><span style=color:#000;font-weight:700>)</span>
KeyboardInterrupt
</code></pre></div><p>We don&rsquo;t want our interpreter to quit when we presee <code>Ctrl + c</code> we only want it to quit on <code>Ctrl + d</code>. So lets try and catch these exceptions and make our <code>ipython</code> tool to behave better.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>from</span> <span style=color:#555>itertools</span> <span style=color:#000;font-weight:700>import</span> count

<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>get_user_input</span>():
    
    <span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>in</span> count():
        <span style=color:#000;font-weight:700>try</span>:
            <span style=color:#000;font-weight:700>yield</span> i, <span style=color:#0086b3>input</span>(f<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>In [{i}]: </span><span style=color:#d14>&#34;</span>)
        <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>KeyboardInterrupt</span>:
            <span style=color:#000;font-weight:700>pass</span>
        <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>EOFError</span>:
            <span style=color:#000;font-weight:700>break</span>
</code></pre></div><p>This would now mean that pressing <code>Ctrl + c</code> won&rsquo;t break the program and you would have to press <code>Ctrl + d</code> to get out. Cool!</p><p>It will not be cool, if you write valid python code in the tool and it won&rsquo;t do anything, right? Lets add the functionality to execute the code we write, but before that, we need to understand some concepts in python.</p><p>In Python, we have <strong>Statements</strong> and <strong>Expressions</strong>.</p><blockquote><p>An Expression in python is something that evalutates and produces some result. Example 10 + 10 -> 20 or a function that returns something. So expression produce at least one value.</p></blockquote><blockquote><p>An Statement on the other end, are everything that make up a line, or that does something example, for loops, assignments.</p></blockquote><p>Now lets continue building our interactive python interpreter.</p><p>The first question comes to mind is how to differentiate between an expression and statement, because they both are executed differently in python.</p><p>Python uses <code>exec</code> to execute a python statement, while <code>eval</code> is used to execute a python expression.</p><p>Its pretty stright forward to differentiate between them. Python&rsquo;s <code>compile</code> function will compile python&rsquo;s expressions with <code>eval</code> which we know for sure that works only for expressions and not for statements (one can go the other way around as well), and would throw an <code>SyntaxError</code> for statemates.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>In [<span style=color:#099>1</span>]: <span style=color:#0086b3>compile</span>(<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>for i in range(10): print(i)</span><span style=color:#d14>&#34;</span>, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>&lt;stdin&gt;</span><span style=color:#d14>&#34;</span>, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>eval</span><span style=color:#d14>&#34;</span>)                                           
Traceback (most recent call last):

  File <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>/home/user/miniconda3/lib/python3.7/site-packages/IPython/core/interactiveshell.py</span><span style=color:#d14>&#34;</span>, line <span style=color:#099>3343</span>, <span style=color:#000;font-weight:700>in</span> run_code
    <span style=color:#000;font-weight:700>exec</span>(code_obj, <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>user_global_ns, <span style=color:#999>self</span><span style=color:#000;font-weight:700>.</span>user_ns)

  File <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>&lt;ipython-input-1-3dcd780a8875&gt;</span><span style=color:#d14>&#34;</span>, line <span style=color:#099>1</span>, <span style=color:#000;font-weight:700>in</span> <span style=color:#000;font-weight:700>&lt;</span>module<span style=color:#000;font-weight:700>&gt;</span>
    <span style=color:#0086b3>compile</span>(<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>for i in range(10): print(i)</span><span style=color:#d14>&#34;</span>, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>&lt;stdin&gt;</span><span style=color:#d14>&#34;</span>, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>eval</span><span style=color:#d14>&#34;</span>)

  File <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>&lt;stdin&gt;</span><span style=color:#d14>&#34;</span>, line <span style=color:#099>1</span>
    <span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>in</span> <span style=color:#0086b3>range</span>(<span style=color:#099>10</span>): <span style=color:#000;font-weight:700>print</span>(i)
      <span style=color:#000;font-weight:700>^</span>
<span style=color:#900;font-weight:700>SyntaxError</span>: invalid syntax
</code></pre></div><p>So now we just try to compile a user input and if it throws an error we know for sure that it is an expression and not a statement and then we can return an <code>eval</code> or <code>exec</code> based on that.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>exec_function</span>(unser_input):
    
    <span style=color:#000;font-weight:700>try</span>:
        <span style=color:#0086b3>compile</span>(user_input, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>&lt;stdin&gt;</span><span style=color:#d14>&#34;</span>, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>eval</span><span style=color:#d14>&#34;</span>)
    <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>SyntaxError</span>:
        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>exec</span>
    <span style=color:#000;font-weight:700>return</span> <span style=color:#0086b3>eval</span>
</code></pre></div><p>Ok so now we have a way to evaluate which type of input the user has provided. We can build it from here, once we apply this function to the user input, we need to also take care of the error the execution of the user code would possibly have.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>from</span> <span style=color:#555>itertools</span> <span style=color:#000;font-weight:700>import</span> count

<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>get_user_input</span>():
    
    <span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>in</span> count():
        <span style=color:#000;font-weight:700>try</span>:
            <span style=color:#000;font-weight:700>yield</span> i, <span style=color:#0086b3>input</span>(f<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>In [{i}]: </span><span style=color:#d14>&#34;</span>)
        <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>KeyboardInterrupt</span>:
            <span style=color:#000;font-weight:700>pass</span>
        <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>EOFError</span>:
            <span style=color:#000;font-weight:700>break</span>


<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>exec_function</span>(user_input):
    
    <span style=color:#000;font-weight:700>try</span>:
        <span style=color:#0086b3>compile</span>(user_input, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>&lt;stdin&gt;</span><span style=color:#d14>&#34;</span>, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>eval</span><span style=color:#d14>&#34;</span>)
    <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>SyntaxError</span>:
        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>exec</span>
    <span style=color:#000;font-weight:700>return</span> <span style=color:#0086b3>eval</span>


<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>main</span>():
    
    <span style=color:#000;font-weight:700>for</span> i, user_input <span style=color:#000;font-weight:700>in</span> get_user_input():
        return_value <span style=color:#000;font-weight:700>=</span> exec_function(user_input)(user_input)
        <span style=color:#000;font-weight:700>if</span> return_value:
            <span style=color:#000;font-weight:700>print</span>(f<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>Out[{i}]: {return_value}</span><span style=color:#d14>&#34;</span>)

<span style=color:#000;font-weight:700>if</span> __name__ <span style=color:#000;font-weight:700>==</span> <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>__main__</span><span style=color:#d14>&#34;</span>:
    main()
</code></pre></div><p>You see in the <code>main</code> function that when we call the <code>exec_function</code> we pass in the <code>user_input</code> and then it returns us <code>exec</code> or <code>eval</code> based on the compile condition and then to that return value we again pass in the <code>user_input</code> to run it.</p><p>Now to catch the error that the <code>exec_function</code> will return we will put the return_value in try exect block</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>main</span>():
    
    <span style=color:#000;font-weight:700>for</span> i, user_input <span style=color:#000;font-weight:700>in</span> get_user_input():
        <span style=color:#000;font-weight:700>try</span>:
            return_value <span style=color:#000;font-weight:700>=</span> exec_function(user_input)(user_input)
        <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>Exception</span> <span style=color:#000;font-weight:700>as</span> e:
            <span style=color:#000;font-weight:700>print</span>(f<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>{e.__class__.__name__}, {e}</span><span style=color:#d14>&#34;</span>)
        <span style=color:#000;font-weight:700>else</span>:
            <span style=color:#000;font-weight:700>if</span> return_value:
                <span style=color:#000;font-weight:700>print</span>(f<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>Out[{i}]: {return_value}</span><span style=color:#d14>&#34;</span>)

</code></pre></div><p>And now we have our own little <code>ipython</code>. The whole code can be found below.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>from</span> <span style=color:#555>itertools</span> <span style=color:#000;font-weight:700>import</span> count

<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>get_user_input</span>():
    
    <span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>in</span> count():
        <span style=color:#000;font-weight:700>try</span>:
            <span style=color:#000;font-weight:700>yield</span> i, <span style=color:#0086b3>input</span>(f<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>In [{i}]: </span><span style=color:#d14>&#34;</span>)
        <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>KeyboardInterrupt</span>:
            <span style=color:#000;font-weight:700>pass</span>
        <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>EOFError</span>:
            <span style=color:#000;font-weight:700>break</span>


<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>exec_function</span>(user_input):
    
    <span style=color:#000;font-weight:700>try</span>:
        <span style=color:#0086b3>compile</span>(user_input, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>&lt;stdin&gt;</span><span style=color:#d14>&#34;</span>, <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>eval</span><span style=color:#d14>&#34;</span>)
    <span style=color:#000;font-weight:700>except</span> <span style=color:#900;font-weight:700>SyntaxError</span>:
        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>exec</span>
    <span style=color:#000;font-weight:700>return</span> <span style=color:#0086b3>eval</span>


<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>main</span>():
    
    <span style=color:#000;font-weight:700>for</span> i, user_input <span style=color:#000;font-weight:700>in</span> get_user_input():
        return_value <span style=color:#000;font-weight:700>=</span> exec_function(user_input)(user_input)
        <span style=color:#000;font-weight:700>if</span> return_value:
            <span style=color:#000;font-weight:700>print</span>(f<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>Out[{i}]: {return_value}</span><span style=color:#d14>&#34;</span>)

<span style=color:#000;font-weight:700>if</span> __name__ <span style=color:#000;font-weight:700>==</span> <span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>__main__</span><span style=color:#d14>&#34;</span>:
    main()
</code></pre></div></div></article><button class=floating-button>
<a class=floating-button__link href=https://jdvala.github.io><span>home</span></a></button></div><footer class=post-footer><div class=footer><div>© 2020, Jay Vala. Theme - Origin by Andrey Parfenov</div><div class=footer__socials><a href=www.github.com/jdvala target=_blank class=social-link title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0v24h24V0H0zm14.534 19.59c-.406.078-.534-.171-.534-.384v-2.195c0-.747-.262-1.233-.55-1.481 1.782-.198 3.654-.875 3.654-3.947.0-.874-.311-1.588-.824-2.147.083-.202.357-1.016-.079-2.117.0.0-.671-.215-2.198.82-.639-.18-1.323-.267-2.003-.271-.68.003-1.364.091-2.003.269-1.528-1.035-2.2-.82-2.2-.82-.434 1.102-.16 1.915-.077 2.118-.512.56-.824 1.273-.824 2.147.0 3.064 1.867 3.751 3.645 3.954-.229.2-.436.552-.508 1.07-.457.204-1.614.557-2.328-.666.0.0-.423-.768-1.227-.825.0.0-.78-.01-.055.487.0.0.525.246.889 1.17.0.0.463 1.428 2.688.944v1.489c0 .211-.129.459-.528.385-3.18-1.057-5.472-4.056-5.472-7.59.0-4.419 3.582-8 8-8s8 3.581 8 8c0 3.533-2.289 6.531-5.466 7.59z"/></svg></a></div></div></footer><script src=https://jdvala.github.io/js/script.js></script></body></html>