<!doctype html><html lang=en><head><meta charset=utf-8><title>Jay Vala</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="How to correctly set environment variables in pytest?"><meta property="og:title" content="Pytest Environment Variables"><meta property="og:description" content="How to correctly set environment variables in pytest?"><meta property="og:type" content="website"><meta property="og:url" content="https://jdvala.github.io/posts/pytest-environment-variables/"><meta itemprop=name content="Pytest Environment Variables"><meta itemprop=description content="How to correctly set environment variables in pytest?"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pytest Environment Variables"><meta name=twitter:description content="How to correctly set environment variables in pytest?"><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=favicon-32.png><link rel=stylesheet href=https://jdvala.github.io/scss/style.min.d1aa507e320f63a9a89fb4d16c025955cea1564900de1060a4b2d7cabbabcdec.css></head><body><header><div class="header header-frame"><div><h1 class=header__title>Pytest Environment Variables</h1><div class=header__description>How to correctly set environment variables in pytest?</div></div><nav class=header-nav><ul class="header-nav-list header-nav-list--menu"><li class=header-nav-list__item><a class=header-nav-list__link href=/about/><span>About</span></a></li></ul><button class=header-nav-list__nav-btn>navigation</button></nav><button class=mb-header__menu-btn>
<span class=mb-header__menu-btn-line></span>
<span class=mb-header__menu-btn-line></span>
<span class=mb-header__menu-btn-line></span></button></div><nav id=mobile-header-nav class=mb-header-nav><button class="mb-header-nav__close-btn flex-center"><svg class="mb-header-nav__svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/><path d="M0 0h24v24H0z" fill="none"/></svg></button><div class=mb-header-nav__wrapper><div class=mb-header-nav__container><svg width="240" height="72" viewBox="0 0 240 72" class="mb-header-nav__title"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Tags</text></svg><ul class=mb-header-nav-list><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://jdvala.github.io/tags/python/>python</a></li><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://jdvala.github.io/tags/testing/>testing</a></li><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://jdvala.github.io/tags/pytest/>pytest</a></li></ul></div><div class=mb-header-nav__container><svg width="240" height="72" viewBox="0 0 240 72" class="mb-header-nav__title"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Menu</text></svg><ul class=mb-header-nav-list><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=/about/>About</a></li></ul></div></div></nav></header><div id=content><article class=post><div class=post-content><h3 id=how-would-you>How would you?</h3><p>‚Ä¶ in my opinion üßê</p><p>Writing test for code can quickly go out of hand if there are a huge number of conditions in the code, which in general there is. I recently came across such a situation where my code was 200 lines and the tests I wrote for it were 400 lines üôà. I know it was too much but I have this practice where in I want to have 100% of test coverage. This practice of mine had sometimes made me pull my hair and prolonged my task for a day or two but it had ensured that there are minimum bugs in my code (at least that‚Äôs what I like to think üòú).</p><p>I can‚Äôt post the code here but I will try to create a minimum working example.</p><p>Consider the following application,</p><p><img src=/example.png alt=example.png></p><p>In this example,</p><ul><li>First get which environment we are running the app in?</li><li>Second, get the username and password for this environment</li><li>Using this username and password generate a token</li><li>Then using this token call the APP which does things‚Ä¶</li></ul><p>Now to test this workflow, I will start writing unit tests. The first test is for <code>setup_environment</code> and then second for <code>get_auth_token</code> and the third test for <code>call_the_app</code> (please excuse my function names).</p><p>For all these functions I will mock different environment variables</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>os</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>from</span> <span style=color:#555>unittest.mock</span> <span style=color:#000;font-weight:700>import</span> Mock, patch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>pytest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#3c5d5d;font-weight:700>@patch</span><span style=color:#000;font-weight:700>.</span>dict(os<span style=color:#000;font-weight:700>.</span>environ, {<span style=color:#d14>&#34;WHICH_ENV&#34;</span>: <span style=color:#d14>&#34;dummy&#34;</span>, <span style=color:#d14>&#34;USERNAME&#34;</span>: <span style=color:#d14>&#34;PEPE&#34;</span>, <span style=color:#d14>&#34;PASSWORD&#34;</span>: <span style=color:#d14>&#34;PASSWORD&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>test_setup_environment</span>():
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic># test my code here.</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#3c5d5d;font-weight:700>@patch</span><span style=color:#000;font-weight:700>.</span>dict(os<span style=color:#000;font-weight:700>.</span>environ, {<span style=color:#d14>&#34;WHICH_ENV&#34;</span>: <span style=color:#d14>&#34;&#34;</span>, <span style=color:#d14>&#34;USERNAME&#34;</span>: <span style=color:#d14>&#34;&#34;</span>, <span style=color:#d14>&#34;PASSWORD&#34;</span>: <span style=color:#d14>&#34;&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>test_setup_environment_failed</span>():
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic># test the failing code here.</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#3c5d5d;font-weight:700>@patch</span><span style=color:#000;font-weight:700>.</span>dict(os<span style=color:#000;font-weight:700>.</span>environ, {<span style=color:#d14>&#34;WHICH_ENV&#34;</span>: <span style=color:#d14>&#34;dev&#34;</span>, <span style=color:#d14>&#34;USERNAME&#34;</span>: <span style=color:#d14>&#34;PEPE&#34;</span>, <span style=color:#d14>&#34;PASSWORD&#34;</span>: <span style=color:#d14>&#34;PASSWORD123&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Imagine here that we had other environment variables as well.</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>test_generate_auth_token</span>():
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic># test my code here.</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#3c5d5d;font-weight:700>@patch</span><span style=color:#000;font-weight:700>.</span>dict(os<span style=color:#000;font-weight:700>.</span>environ, {<span style=color:#d14>&#34;WHICH_ENV&#34;</span>: <span style=color:#d14>&#34;dev&#34;</span>, <span style=color:#d14>&#34;USERNAME&#34;</span>: <span style=color:#d14>&#34;PEPE&#34;</span>, <span style=color:#d14>&#34;PASSWORD&#34;</span>: <span style=color:#d14>&#34;PASSWORD123&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Imagine here that we had other environment variables as well.</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>test_call_the_app</span>():
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic># test my code here.</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><p>Now as you can see that I was continuously using the same line of code to decorate all the functions which is not good as I am a firm believer of DRY (Don‚Äôt repeat yourself). This habit combined with my obsession of testing 100% of my code, had me writing 1000 lines of code for testing a few functions. There was a lot of repetition, I didn‚Äôt like it but most of the time had to give up on DRY as I had other task to finish.</p><p>Today I had some time on my hand and wanted to see how could I refactor my current code (200 lines of code and almost 500 lines in test cases) to have less repetitions. I came across an answer on stackoverflow (which I don‚Äôt have the link for now) but the answer was to use <code>monkeypatch</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>os</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>from</span> <span style=color:#555>unittest.mock</span> <span style=color:#000;font-weight:700>import</span> Mock, patch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>pytest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#3c5d5d;font-weight:700>@pytest</span><span style=color:#000;font-weight:700>.</span>fixture(autouse<span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>True</span>)
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>mock_environment_variables</span>(monkeypatch):
</span></span><span style=display:flex><span>	monkeypatch<span style=color:#000;font-weight:700>.</span>setenv(<span style=color:#d14>&#34;WHICH_ENV&#34;</span>, <span style=color:#d14>&#34;dummy&#34;</span>)
</span></span><span style=display:flex><span>	monkeypatch<span style=color:#000;font-weight:700>.</span>setenv(<span style=color:#d14>&#34;USERNAME&#34;</span>, <span style=color:#d14>&#34;PEPE&#34;</span>)
</span></span><span style=display:flex><span>	monkeypatch<span style=color:#000;font-weight:700>.</span>setenv(<span style=color:#d14>&#34;PASSWORD&#34;</span>, <span style=color:#d14>&#34;PASSWORD&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>test_setup_environment</span>():
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic># test my code here.</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><p>But what if we need to change the environment variable, it was easy when the function was decorated with <code>patch.dict</code> and I can easily change it at one place. Well it is possible in unset them, or better set them again for just a single function,</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>os</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>from</span> <span style=color:#555>unittest.mock</span> <span style=color:#000;font-weight:700>import</span> Mock, patch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>pytest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#3c5d5d;font-weight:700>@pytest</span><span style=color:#000;font-weight:700>.</span>fixture(autouse<span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>True</span>)
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>mock_environment_variables</span>(monkeypatch):
</span></span><span style=display:flex><span>	monkeypatch<span style=color:#000;font-weight:700>.</span>setenv(<span style=color:#d14>&#34;WHICH_ENV&#34;</span>, <span style=color:#d14>&#34;dummy&#34;</span>)
</span></span><span style=display:flex><span>	monkeypatch<span style=color:#000;font-weight:700>.</span>setenv(<span style=color:#d14>&#34;USERNAME&#34;</span>, <span style=color:#d14>&#34;PEPE&#34;</span>)
</span></span><span style=display:flex><span>	monkeypatch<span style=color:#000;font-weight:700>.</span>setenv(<span style=color:#d14>&#34;PASSWORD&#34;</span>, <span style=color:#d14>&#34;PASSWORD&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>test_setup_environment</span>():
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic># test my code here.</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>test_setup_environment_failed</span>(monkeypatch):
</span></span><span style=display:flex><span>	monkeypatch<span style=color:#000;font-weight:700>.</span>setenv(<span style=color:#d14>&#34;WHICH_ENV&#34;</span>, <span style=color:#d14>&#34;&#34;</span>)
</span></span><span style=display:flex><span>	monkeypatch<span style=color:#000;font-weight:700>.</span>setenv(<span style=color:#d14>&#34;USERNAME&#34;</span>, <span style=color:#d14>&#34;&#34;</span>)
</span></span><span style=display:flex><span>	monkeypatch<span style=color:#000;font-weight:700>.</span>setenv(<span style=color:#d14>&#34;PASSWORD&#34;</span>, <span style=color:#d14>&#34;&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic># test the failing code here.</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><p>And you can go about testing your code normally afterwards not having to worry about the environment variables.</p></div></article><button class=floating-button>
<a class=floating-button__link href=https://jdvala.github.io><span>home</span></a></button></div><footer class=post-footer><div class=footer><div>¬© 2020, Jay Vala. Theme - Origin by Andrey Parfenov</div><div class=footer__socials><a href=www.github.com/jdvala target=_blank class=social-link title="Github link" rel=noopener aria-label="follow on Github‚Äî‚ÄîOpens in a new window"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0v24h24V0H0zm14.534 19.59c-.406.078-.534-.171-.534-.384v-2.195c0-.747-.262-1.233-.55-1.481 1.782-.198 3.654-.875 3.654-3.947.0-.874-.311-1.588-.824-2.147.083-.202.357-1.016-.079-2.117.0.0-.671-.215-2.198.82-.639-.18-1.323-.267-2.003-.271-.68.003-1.364.091-2.003.269-1.528-1.035-2.2-.82-2.2-.82-.434 1.102-.16 1.915-.077 2.118-.512.56-.824 1.273-.824 2.147.0 3.064 1.867 3.751 3.645 3.954-.229.2-.436.552-.508 1.07-.457.204-1.614.557-2.328-.666.0.0-.423-.768-1.227-.825.0.0-.78-.01-.055.487.0.0.525.246.889 1.17.0.0.463 1.428 2.688.944v1.489c0 .211-.129.459-.528.385C6.292 18.533 4 15.534 4 12c0-4.419 3.582-8 8-8s8 3.581 8 8c0 3.533-2.289 6.531-5.466 7.59z"/></svg></a></div></div></footer><script src=https://jdvala.github.io/js/script.js></script></body></html>