<!doctype html><html lang=en><head><meta charset=utf-8><title>Jay Vala</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Grouby-apply dask"><meta property="og:title" content="Groupby and Apply with Dask on pandas DataFrame"><meta property="og:description" content="Grouby-apply dask"><meta property="og:type" content="website"><meta property="og:url" content="https://jdvala.github.io/posts/2021-05-18-dask-groupby-apply/"><meta itemprop=name content="Groupby and Apply with Dask on pandas DataFrame"><meta itemprop=description content="Grouby-apply dask"><meta name=twitter:card content="summary"><meta name=twitter:title content="Groupby and Apply with Dask on pandas DataFrame"><meta name=twitter:description content="Grouby-apply dask"><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=favicon-32.png><link rel=stylesheet href=https://jdvala.github.io/scss/style.min.d1aa507e320f63a9a89fb4d16c025955cea1564900de1060a4b2d7cabbabcdec.css></head><body><header><div class="header header-frame"><div><h1 class=header__title>Groupby and Apply with Dask on pandas DataFrame</h1><div class=header__description>Grouby-apply dask</div></div><nav class=header-nav><ul class="header-nav-list header-nav-list--menu"><li class=header-nav-list__item><a class=header-nav-list__link href=/about/><span>About</span></a></li></ul><button class=header-nav-list__nav-btn>navigation</button></nav><button class=mb-header__menu-btn>
<span class=mb-header__menu-btn-line></span><span class=mb-header__menu-btn-line></span><span class=mb-header__menu-btn-line></span></button></div><nav id=mobile-header-nav class=mb-header-nav><button class="mb-header-nav__close-btn flex-center"><svg class="mb-header-nav__svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"
            ><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                /><path d="M0 0h24v24H0z" fill="none" /></svg></button><div class=mb-header-nav__wrapper><div class=mb-header-nav__container><svg width="240" height="72" viewBox="0 0 240 72" class="mb-header-nav__title"
                ><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Tags</text></svg><ul class=mb-header-nav-list><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://jdvala.github.io/tags/dask/>dask</a></li><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://jdvala.github.io/tags/python/>python</a></li><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=https://jdvala.github.io/tags/pandas/>pandas</a></li></ul></div><div class=mb-header-nav__container><svg width="240" height="72" viewBox="0 0 240 72" class="mb-header-nav__title"
                ><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">Menu</text></svg><ul class=mb-header-nav-list><li class=mb-header-nav-list__item><a class=mb-header-nav-list__link href=/about/>About</a></li></ul></div></div></nav></header><div id=content><article class=post><div class=post-content><p>Recently, I have started using <a href=https://dask.org/>Dask</a> to make some pandas computations faster, its a really good tool. It has a bit of learning curve, but its worth it.</p><p>Until now I used to use <a href=https://github.com/nalepae/pandarallel/tree/v1.5.2>Pandarallel</a> for parallelization of pandas apply functions. Its a good little tool and there are many alternatives to it as well. One of it is written by a good friend of my, and its called <a href=https://pypi.org/project/mapply/>Mappy</a>.</p><p>Let&rsquo;s, look at how to use Dask to first groupby and then apply. For the example I will use titanic dataset which you can find <a href=https://raw.githubusercontent.com/datasciencedojo/datasets/master/titanic.csv>here</a>. Its a csv file so lets load it,</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>import</span> <span style=color:#555>pandas</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>pd</span>

df <span style=color:#000;font-weight:700>=</span> pd<span style=color:#000;font-weight:700>.</span>read_csv(<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>titanic.csv</span><span style=color:#d14>&#34;</span>)

df<span style=color:#000;font-weight:700>.</span>head()
</code></pre></div><p>| | PassengerId | Survived | Pclass | Name | Sex | Age | SibSp | Parch | Ticket | Fare | Cabin | Embarked |
|&ndash;:|++++++++++++:|+++++++++:|++++++-:|++++++++++++++++++++++++++++++++++++++++++++++++&ndash;:|++++++-:|+++&ndash;:|++++++:|++++++:|+++++++++++++++&ndash;:|++++++&ndash;:|++++++:|+++++++++-|
| 0 | 1 | 0 | 3 | Braund, Mr. Owen Harris | male | 22.0 | 1 | 0 | A/5 21171 | 7.2500 | NaN | S |
| 1 | 2 | 1 | 1 | Cumings, Mrs. John Bradley (Florence Briggs Th&mldr; | female | 38.0 | 1 | 0 | PC 17599 | 71.2833 | C85 | C |
| 2 | 3 | 1 | 3 | Heikkinen, Miss. Laina | female | 26.0 | 0 | 0 | STON/O2. 3101282 | 7.9250 | NaN | S |
| 3 | 4 | 1 | 1 | Futrelle, Mrs. Jacques Heath (Lily May Peel) | female | 35.0 | 1 | 0 | 113803 | 53.1000 | C123 | S |
| 4 | 5 | 0 | 3 | Allen, Mr. William Henry | male | 35.0 | 0 | 0 | 373450 | 8.0500 | NaN | S |</p><p>Now, to formulate the problem lets see how many male and female passengers survived.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>survived</span>(x):
    <span style=color:#000;font-weight:700>return</span> x<span style=color:#000;font-weight:700>.</span>Survived<span style=color:#000;font-weight:700>.</span>count()
</code></pre></div><p>If we were to do it pandas way, we can do it like</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>%</span>time
titanic<span style=color:#000;font-weight:700>.</span>groupby(<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>Sex</span><span style=color:#d14>&#34;</span>)<span style=color:#000;font-weight:700>.</span>apply(survived)
</code></pre></div><p>Which gives out</p><p>| | survived | |
|++++++-:|+++++++++:|+++&ndash;|
| Sex | | |
| female | 0 | 314 |
| male | 0 | 577 |</p><p>To do this same thing with help of dask, we first need to translate the dataframe into what dask would understand, for dask and pandas a dataframe object is different.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#000;font-weight:700>import</span> <span style=color:#555>dask.dataframe</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>dd</span>

dask_dataframe <span style=color:#000;font-weight:700>=</span> dd<span style=color:#000;font-weight:700>.</span>from_pandas(df, npartitions<span style=color:#000;font-weight:700>=</span><span style=color:#099>2</span>)

dask_dataframe
</code></pre></div><p>| | PassengerId | Survived | Pclass | Name | Sex | Age | SibSp | Parch | Ticket | Fare | Cabin | Embarked |
|++++++++++++&ndash;:|++++++++++++:|+++++++++:|++++++-:|++++++-:|++++++-:|++++++&ndash;:|++++++:|++++++:|++++++-:|++++++&ndash;:|++++++-:|+++++++++:|
| npartitions=2 | | | | | | | | | | | | |
| 0 | int64 | int64 | int64 | object | object | float64 | int64 | int64 | object | float64 | object | object |
| 446 | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; |
| 890 | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; |</p><p>The above statment will translate the dataframe from pandas to something dask will understand. Now you might ask what the hell is this <code>npartitions</code> mean. Its very very simple, dask when converting the pandas dataframe object into dask dataframe object will divide the dataframe into <code>n</code> partitions so that it can be processed on different core (CPUs). This is how dask makes processing faster.</p><blockquote><p>Note: There is however one drawback of such division, if there is dependency between the dataframe partitions when processing, then dask will not be useful. The overhead of passing information between the chunks or partitions in different CPU cores will make use of dask futile for such a case.</p></blockquote><p>Once the dataframe object is translated into dask, all we have got to do is</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>output <span style=color:#000;font-weight:700>=</span> dask_dataframe<span style=color:#000;font-weight:700>.</span>groupby(<span style=color:#d14></span><span style=color:#d14>&#34;</span><span style=color:#d14>Sex</span><span style=color:#d14>&#34;</span>)<span style=color:#000;font-weight:700>.</span>apply(survived)
</code></pre></div><p>Once we run the cell, you will note that nothing happens, this is because dask works on principle of lazy execution. You can learn more about it <a href=https://tutorial.dask.org/01x_lazy.html>here</a>, but on a higher level when we run the above cell, dask will generate a graph of how the data will distributed and where which operation will occur.</p><blockquote><p>Note: You can use <code>output.visualize()</code> to see a graph of the execution.</p></blockquote><p>So to run the actual computation you need to use compute function</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>output<span style=color:#000;font-weight:700>.</span>compute()
</code></pre></div><p>| | survived | |
|++++++-:|+++++++++:|+++&ndash;|
| Sex | | |
| female | 0 | 314 |
| male | 0 | 577 |</p><p>This ends a small tutorial on how to use dask for groupby and apply.</p><p>I am planning on writing a whole series on dask and how its an alternative to some of the things you can do with pandas.</p></div></article><button class=floating-button>
<a class=floating-button__link href=https://jdvala.github.io><span>home</span></a></button></div><footer class=post-footer><div class=footer><div>© 2020, Jay Vala. Theme - Origin by Andrey Parfenov</div><div class=footer__socials><a href=www.github.com/jdvala target=_blank class=social-link title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0v24h24V0H0zm14.534 19.59c-.406.078-.534-.171-.534-.384v-2.195c0-.747-.262-1.233-.55-1.481 1.782-.198 3.654-.875 3.654-3.947.0-.874-.311-1.588-.824-2.147.083-.202.357-1.016-.079-2.117.0.0-.671-.215-2.198.82-.639-.18-1.323-.267-2.003-.271-.68.003-1.364.091-2.003.269-1.528-1.035-2.2-.82-2.2-.82-.434 1.102-.16 1.915-.077 2.118-.512.56-.824 1.273-.824 2.147.0 3.064 1.867 3.751 3.645 3.954-.229.2-.436.552-.508 1.07-.457.204-1.614.557-2.328-.666.0.0-.423-.768-1.227-.825.0.0-.78-.01-.055.487.0.0.525.246.889 1.17.0.0.463 1.428 2.688.944v1.489c0 .211-.129.459-.528.385-3.18-1.057-5.472-4.056-5.472-7.59.0-4.419 3.582-8 8-8s8 3.581 8 8c0 3.533-2.289 6.531-5.466 7.59z"/></svg></a></div></div></footer><script src=https://jdvala.github.io/js/script.js></script></body></html>